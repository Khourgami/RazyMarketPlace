@page "/parties"
@using RazySoft.Market.Admin.Application.DTOs
@using RazySoft.Market.Admin.Web.Services.UiContracts
@using RazySoft.Market.Admin.Web.Services
@inject IPartyUiService PartyUiService

<h2 class="mb-4">Party List</h2>

@* <div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search by name..." @bind="SearchTerm" @bind:event="oninput" />
            <button class="btn btn-primary" type="button" @onclick="SearchParties">Search</button>
        </div>
    </div>
</div> *@

@if (_isLoading)
{
    <LoadingSpinner />
}
else if (!_parties.Any() && _hasLoaded)
{
    <EmptyState EntityName="Parties" Message="No parties match the search criteria." />
}
else if (_errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @_errorMessage
    </div>
}
else
{
    <EntityTable Items="_parties" DetailsRoute="Parties" />

    <nav>
        <ul class="pagination">
            <li class="page-item @(_pageIndex == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="@(() => ChangePage(_pageIndex - 1))">Previous</button>
            </li>
            <li class="page-item active"><span class="page-link">@_pageIndex</span></li>
            <li class="page-item @(_parties.Count < _pageSize ? "disabled" : "")">
                <button class="page-link" @onclick="@(() => ChangePage(_pageIndex + 1))">Next</button>
            </li>
        </ul>
    </nav>
}


@code {
    private IReadOnlyList<PartyDto> _parties = new List<PartyDto>();
    private bool _isLoading = true;
    private bool _hasLoaded = false;
    private string? _errorMessage;
    private int _pageIndex = 1;
    private const int _pageSize = 10;
    private string _searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadPartiesAsync();
    }

    private async Task LoadPartiesAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        _parties = new List<PartyDto>();
        StateHasChanged(); // Immediately show spinner

        var response = await PartyUiService.GetPartiesAsync(_searchTerm, _pageIndex, _pageSize);

        if (response.IsSuccess && response.Data != null)
        {
            _parties = response.Data.ToList();
        }
        else
        {
            _errorMessage = response.ErrorMessage;
        }

        _isLoading = false;
        _hasLoaded = true;
    }

    private async Task ChangePage(int newIndex)
    {
        if (newIndex >= 1)
        {
            _pageIndex = newIndex;
            await LoadPartiesAsync();
        }
    }

    private async Task SearchParties()
    {
        _pageIndex = 1; // Reset to first page on search
        await LoadPartiesAsync();
    }
}